<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Config</title>
    <style>
        body {
            background-color: #222;
            color: #ddd;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            grid-gap: 10px;
            justify-content: center;
            max-width: 1040px;
            min-width: 1040px;
            margin: 20px auto;
            padding: 10px;
            background-color: #333;
            border: 1px solid #444;
            border-radius: 5px;
        }

        .button {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #555;
            width: 200px;
            height: 200px;
            background-color: #444;
            color: #ddd;
            border-radius: 5px;
            overflow: hidden;
        }

        .button.hover {
            background-color: #555;
        }

        textarea {
            position: absolute;
            bottom: 0;
            width: 100%;
            box-sizing: border-box;
            background-color: #333d;
            color: #ddd;
            border: none;
            resize: none;
            font-family: Arial, sans-serif;
            padding: 5px;
        }

        .image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
   </style>
</head>
<body>
    <div class="grid" id="grid">
    </div>
    <script>
        let config = {};
        let changeTimer;

        function handleMacroChange() {
            const target = event.target;
            clearTimeout(changeTimer);

            changeTimer = setTimeout(() => {
                const newMacro = target.value;
                const x = target.getAttribute('data-x');
                const y = target.getAttribute('data-y');
                config[y][x].action = newMacro;
                saveConfig();
            }, 1000);
        }

        function loadConfig() {
            fetch('/config')
                .then(response => response.json())
                .then(data => {
                    config = data;
                    const grid = document.getElementById('grid');
                    grid.innerHTML = '';
                    for (let y = 0; y < 5; y++) {
                        for (let x = 0; x < 5; x++) {
                            const div = document.createElement('div');
                            const dropArea = document.createElement('div');
                            const textarea = document.createElement('textarea');
                            const img = document.createElement('img');

                            div.className = 'button';
                            div.setAttribute('data-x', x);
                            div.setAttribute('data-y', y);

                            textarea.rows = 2;
                            textarea.cols = 10;
                            textarea.setAttribute('data-x', x);
                            textarea.setAttribute('data-y', y);
                            textarea.addEventListener('input', handleMacroChange);

                            div.addEventListener('dragover', handleDragOver);
                            div.addEventListener('dragenter', handleDragEnter);
                            div.addEventListener('dragleave', handleDragLeave);
                            div.addEventListener('drop', handleDrop);
 
                            if (config == null || !Object.keys(config).includes(String(y)) || !Object.keys(config[y]).includes(String(x))) {
                                if (!Object.keys(config).includes(String(y))) {
                                    config[y] = {};
                                }
                                config[y][x] = {};
                            } else {
                                const button = config[y][x];
                                if (button.image && button.image != '') {
                                    img.src = 'images/' + button.image;
                                    img.className = 'image';
                                }
                                if (button.name) {
                                    textarea.name = button.name;
                                }
                                if (button.action) {
                                    textarea.value = button.action;
                                }
                            }

                            div.appendChild(textarea);
                            div.appendChild(dropArea);
                            div.appendChild(img);
                            grid.appendChild(div);
                        }
                    }
                });
        }

        function saveConfig() {
            const formData = new FormData();
            formData.append('config', JSON.stringify(config));
            fetch('/update', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                } else {
                    alert('Failed to update config.');
                }
            });
        }

        function handleDragOver(event) {
            event.preventDefault();
        }

        function handleDragEnter(event) {
            event.target.classList.add('hover');
        }

        function handleDragLeave(event) {
            event.target.classList.remove('hover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.target.classList.remove('hover');
            const file = event.dataTransfer.files[0];
            if (file.type === 'image/png') {
                const x = event.target.getAttribute('data-x');
                const y = event.target.getAttribute('data-y');
                const formData = new FormData();

                formData.append('file', file);

                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        const img = event.target.querySelector('img');
                        if (img) {
                            img.src = 'images/' + file.name;
                        }
                        config[y][x].image = file.name;
                        saveConfig();
 
                    } else {
                        alert('Failed to upload file.');
                    }
                })
                .catch(error => {
                    console.error('Error uploading file:', error);
                    alert('Failed to upload file.');
                });
            } else {
                alert('Only PNG files are allowed.');
            }
        }

        loadConfig();
    </script>
</body>
</html>

